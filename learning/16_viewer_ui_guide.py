"""
Newton 知识文档 16：Newton Viewer 可视化界面操作指南
====================================================

【本文件目的】
这不是一个可运行的示例，而是对 Newton Viewer（OpenGL 可视化查看器）
左侧控制面板和操作方式的完整说明。

当你运行任何 Newton 示例时（比如 uv run python learning/01_basic_pendulum_annotated.py），
会弹出一个 3D 可视化窗口，左侧是控制面板，中间是 3D 场景。

【源码位置】
  Viewer 主类:        newton/_src/viewer/viewer_gl.py  → ViewerGL
  GUI 渲染:           newton/_src/viewer/gl/gui.py     → GUI 样式和 ImGui 初始化
  相机控制:           newton/_src/viewer/camera.py     → Camera
  风力系统:           newton/_src/viewer/wind.py       → Wind
  渲染器:             newton/_src/viewer/gl/opengl.py  → OpenGLRenderer

【面板 UI 代码位置】
  所有左侧面板的选项定义在:
  newton/_src/viewer/viewer_gl.py 第 1282-1421 行


================================================================================
一、左侧面板完整说明（从上到下）
================================================================================

┌─────────────────────────────────────────────────────────────────────────┐
│  Newton Viewer v0.2.0                          ← 版本号                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ▼ Model Information                           ← 第1区：模型信息       │
│  ──────────────────────                                                 │
│    Worlds: 1                                    ← 并行世界数量          │
│    Up Axis: Z                                   ← 哪个轴朝上           │
│    Gravity: (0.00, 0.00, -9.81)                 ← 重力向量              │
│    ☐ Pause                                      ← 暂停/恢复仿真        │
│                                                                         │
│  ▼ Visualization                                ← 第2区：可视化控制     │
│  ──────────────────────                                                 │
│    ☑ Show Joints                                ← 显示关节              │
│    ☑ Show Contacts                              ← 显示碰撞接触点        │
│    ☑ Show Particles                             ← 显示粒子（布料顶点）  │
│    ☑ Show Springs                               ← 显示弹簧连线          │
│    ☑ Show Center of Mass                        ← 显示质心位置          │
│    ☑ Show Cloth                                 ← 显示布料面片          │
│    ☑ Show Collision                             ← 显示碰撞几何体        │
│    ☑ Show Visual                                ← 显示可视化几何体      │
│    ☐ Show Inertia Boxes                         ← 显示惯性等效盒子      │
│                                                                         │
│  ▼ Example Options                              ← 第3区：示例自定义参数 │
│  ──────────────────────                                                 │
│    (每个示例不同，见下方详细说明)                                        │
│                                                                         │
│  ▼ Rendering Options                            ← 第4区：渲染选项       │
│  ──────────────────────                                                 │
│    ☑ VSync                                      ← 垂直同步              │
│    ☑ Sky                                        ← 显示天空背景          │
│    ☑ Shadows                                    ← 显示阴影              │
│    ☐ Wireframe                                  ← 线框模式              │
│    [■] Light Color                              ← 灯光颜色选择器        │
│    [■] Sky Color                                ← 天空颜色选择器        │
│    [■] Ground Color                             ← 地面颜色选择器        │
│                                                                         │
│  ▸ Wind                                         ← 第5区：风力（默认折叠）│
│                                                                         │
│  ▼ Camera                                       ← 第6区：相机信息       │
│  ──────────────────────                                                 │
│    Position: (x, y, z)                           ← 相机位置              │
│    FOV: 45.0°                                    ← 视场角                │
│    Pitch: -15.0°                                 ← 俯仰角                │
│    Yaw: 45.0°                                    ← 偏航角                │
│    Controls:                                                             │
│    WASD - Move camera                            ← 移动相机              │
│    QE - Pan up/down                              ← 上下平移              │
│    Left Click - Look around                      ← 环视                  │
│    Right Click - Pick objects                     ← 拾取物体              │
│    Scroll - Zoom                                 ← 缩放                  │
│    Space - Pause/Resume                           ← 暂停/恢复             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘


================================================================================
二、各区域详细解释
================================================================================

--------------------------------------------------------------------------------
2.1 Model Information（模型信息）
--------------------------------------------------------------------------------

这些是仿真模型的基本属性，由 model = builder.finalize() 后确定，不可修改。

  Worlds:   并行世界数量。如果你用了 replicate(num_worlds=100)，这里就是 100。
            每个世界独立仿真，互不影响，但共享同一块 GPU 内存。

  Up Axis:  坐标系的"上"方向。Newton 默认 Z 轴朝上。
            有些引擎用 Y 轴朝上（如 Unity），注意区别。

  Gravity:  重力向量。默认 (0, 0, -9.81)，即 Z 轴向下 9.81 m/s²。
            可以在代码中通过 model.gravity 修改。

  Pause:    勾选后暂停仿真（step() 不再被调用），画面冻结。
            也可以按键盘空格键切换暂停/恢复。
            暂停后你可以用 WASD 自由移动相机观察场景。

--------------------------------------------------------------------------------
2.2 Visualization（可视化控制）
--------------------------------------------------------------------------------

这组复选框控制场景中哪些元素可见。勾选/取消立即生效。

  Show Joints:         显示关节的位置和旋转轴（用小线段/圆锥表示）。
                       关节是连接两个刚体的约束（铰链、滑轨、球关节等）。
                       适合调试关节安装位置是否正确。

  Show Contacts:       显示碰撞检测产生的接触点。
                       每个接触点用一个小点/法线箭头表示。
                       适合调试碰撞是否正常（有没有穿透、接触点位置对不对）。

  Show Particles:      显示粒子（小球）。
                       布料和软体的每个顶点就是一个粒子。
                       粒子系统（如 MPM 的沙粒）也显示为粒子。

  Show Springs:        显示弹簧连线。
                       布料/软体中粒子之间的弹簧约束用细线表示。

  Show Center of Mass: 显示每个刚体的质心位置（一个小标记）。
                       质心不一定在物体的几何中心（取决于质量分布）。

  Show Cloth:          显示布料的三角面片（填充三角形面）。
                       和 Show Particles 配合：粒子是顶点，布料是面。

  Show Collision:      显示碰撞几何体。这是物理引擎用来做碰撞检测的形状，
                       通常比可视化几何体简单（比如一个复杂机器人的碰撞体可能
                       只是几个简单胶囊/盒子）。

  Show Visual:         显示可视化几何体。这是"好看的"渲染形状（高精度网格），
                       不参与物理计算，只用于显示。

  Show Inertia Boxes:  显示惯性等效盒子。每个刚体的惯性张量可以用一个等效盒子
                       来可视化，盒子的大小反映质量分布。适合检查惯性设置是否合理。

【提示】
  - 调试碰撞问题时：开启 Show Collision + Show Contacts
  - 调试关节问题时：开启 Show Joints
  - 看布料仿真时：开启 Show Cloth + Show Particles
  - 检查物理属性时：开启 Show Center of Mass + Show Inertia Boxes

--------------------------------------------------------------------------------
2.3 Example Options（示例自定义参数）
--------------------------------------------------------------------------------

这部分内容因示例而异，由每个示例通过 viewer.register_ui_callback() 注册。

对于 05_diffsim_ball 示例，这里显示的是优化相关的信息：
  - 当前的损失值 (loss)
  - 优化迭代次数
  - 小球的初始速度参数

其他示例可能显示不同的选项。

源码位置: viewer_gl.py 第 1342-1345 行
    if imgui.collapsing_header("Example Options"):
        for callback in self._ui_callbacks["side"]:
            callback(self.ui.imgui)

--------------------------------------------------------------------------------
2.4 Rendering Options（渲染选项）
--------------------------------------------------------------------------------

控制 3D 渲染效果，不影响物理仿真：

  VSync:      垂直同步。开启后帧率锁定在显示器刷新率（通常 60fps），
              关闭后帧率不受限（可能上百 fps），但可能出现画面撕裂。

  Sky:        是否渲染天空背景。关闭后背景变成纯色。

  Shadows:    是否渲染阴影。关闭后可以提高渲染性能。

  Wireframe:  线框模式（铁丝网模式）。
              关闭时（默认）：物体是实心的，表面填充颜色，像真实物体。
              开启时：物体只显示边线，像用铁丝弯成的骨架，可以看穿物体。

              关闭 (默认):              开启 (Wireframe):
              ┌──────────────┐          ┌──────────────┐
              │██████████████│          │              │
              │██████████████│          │              │
              │██████████████│          │              │
              │██████████████│          │              │
              └──────────────┘          └──────────────┘
              表面填充，看不到内部        只有边框线，可以看穿

              实际用途：
              - 查看网格是怎么划分的（三角形/四面体的边）
              - 检查物体之间是否穿透（实心模式下被挡住看不到）
              - 调试碰撞几何体的形状是否正确

  Light Color:  灯光颜色。点击颜色块可以用颜色选择器调整。
  Sky Color:    天空颜色。
  Ground Color: 地面颜色。

--------------------------------------------------------------------------------
2.5 Wind（风力效果）
--------------------------------------------------------------------------------

默认折叠。展开后可以调整风力参数，主要影响布料仿真。

  Wind Amplitude:   风力强度（-2.0 到 2.0）
  Wind Period:      风的周期（1.0 到 30.0 秒，风力变化的周期）
  Wind Frequency:   风的频率（0.1 到 5.0）
  Wind Direction:   风的方向 (x, y, z)，每个分量 -1.0 到 1.0

【注意】风力只对粒子系统（布料、软体）有效果，对刚体无效。

--------------------------------------------------------------------------------
2.6 Camera（相机信息与操作）
--------------------------------------------------------------------------------

显示当前相机的状态信息。

  Position:  相机在世界坐标中的位置 (x, y, z)
  FOV:       视场角（Field of View），默认 45°
  Pitch:     俯仰角（上下看的角度）
  Yaw:       偏航角（左右看的角度）


================================================================================
三、键盘和鼠标操作速查
================================================================================

┌──────────────────────┬───────────────────────────────────────────────┐
│ 操作                  │ 效果                                          │
├──────────────────────┼───────────────────────────────────────────────┤
│ W / A / S / D         │ 前 / 左 / 后 / 右 移动相机                    │
│ Q / E                 │ 上 / 下 平移相机                              │
│ 鼠标左键 + 拖动       │ 环视（改变相机朝向）                          │
│ 鼠标右键              │ 拾取/选中场景中的物体                         │
│ 鼠标滚轮              │ 缩放（前进/后退）                             │
│ 空格键                │ 暂停 / 恢复仿真                               │
│ Escape                │ 关闭窗口                                      │
└──────────────────────┴───────────────────────────────────────────────┘


================================================================================
四、右上角信息说明
================================================================================

窗口右上角显示实时性能信息：

  FPS:              每秒渲染帧数（Frames Per Second）
  Bodies:           场景中刚体的数量
  Particles:        场景中粒子的数量
  Shapes:           场景中碰撞形状的数量
  Joints:           场景中关节的数量
  Unique Distances: 碰撞对的数量


================================================================================
五、diffsim_ball 示例的画面解读
================================================================================

05_diffsim_ball 是一个"可微仿真"示例，画面中的元素含义：

  黑色小方块:           小球（发射体），从左侧发射
  蓝色长方体:           目标物体，小球需要命中它
  彩色弧线（多条）:     每次优化迭代的小球飞行轨迹
    - 红/黄/绿/蓝:      颜色代表不同迭代次数
    - 越靠近蓝色目标:    说明优化在收敛（初始速度越来越准）

  优化流程:
    1. 设定一个初始速度参数 → 小球飞出一条轨迹
    2. 计算损失函数 loss（小球最终位置离目标多远）
    3. 用 wp.Tape() 自动微分，算出 loss 对初始速度的梯度
    4. 用梯度下降更新初始速度 → 下一次轨迹更接近目标
    5. 重复，直到小球精准命中目标

  这就是可微物理（Differentiable Physics）的核心思想：
  整个物理仿真过程可以求导，用梯度优化来找到最优参数。

  终端输出中的 "numeric grad" 和 "analytic grad" 分别是：
    - numeric grad:  用有限差分法算的梯度（(f(x+ε)-f(x-ε))/(2ε)，慢但可靠）
    - analytic grad: 用 wp.Tape() 自动微分算的梯度（快，但需要验证正确性）
    - 两者应该非常接近，说明自动微分实现正确


================================================================================
六、棋盘格地面说明
================================================================================

画面中灰色的棋盘格是地面（Ground Plane）。
在代码中通过 builder.add_ground_plane() 添加。
它是一个无限大的平面，位于 z=0 处，物体会停在上面而不会穿透。
棋盘格纹理只是为了方便观察物体运动（有参照物更容易看出位移）。
"""
